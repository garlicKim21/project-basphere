# Basphere 아키텍처

## 전체 아키텍처 개요

```
┌──────────────────────────────────────────────────────────────────────────┐
│                              Backstage Portal                             │
│                     (사용자 포털, 서비스 카탈로그)                          │
└────────────────────────────────┬─────────────────────────────────────────┘
                                 │
┌────────────────────────────────▼─────────────────────────────────────────┐
│                           Control Plane                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │  Crossplane │  │ Cluster API │  │   ArgoCD    │  │   Harbor    │     │
│  │  (인프라)   │  │ (K8s 클러스터)│  │   (GitOps)  │  │  (Registry) │     │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │
└────────────────────────────────┬─────────────────────────────────────────┘
                                 │
┌────────────────────────────────▼─────────────────────────────────────────┐
│                         Tenant Infrastructure                             │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                    Tenant Network (OPNsense)                        │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 │ │
│  │  │  K8s Cluster│  │  K8s Cluster│  │    VMs      │                 │ │
│  │  │  (Dev)      │  │  (Prod)     │  │             │                 │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                 │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────┘
```

## OCI (Oracle Cloud Infrastructure)

### 역할

- Talos Omni 셀프 호스팅
- On-premise 컨트롤 플레인 프로비저닝

### 배포 옵션

| 옵션 | 장점 | 단점 |
|------|------|------|
| **단독 VM** | 간단히 컨테이너로 Omni 배포 가능 (공식 문서 가이드) | 확장성 제한 |
| **단일 노드 K8s** | OCI 클라우드 컨트롤러 활용, 추가 기능 배포 용이 | 설정 복잡 |

### 추가 기능 고려

- 모니터링 허브
- 사용자 포털 (Backstage)

### 환경 정보

- **리전**: 싱가포르 1
- **고려사항**: 지리적 거리로 인한 응답속도 문제 가능성
- **VPN**: Site-to-Site으로 On-premise와 연결 유지

## On-premise 컨트롤 플레인

### 역할

On-premise의 사용자 테넌트 자원 프로비저닝 및 관리

### 구현 방법

Omni로 프로비저닝되는 Kubernetes 클러스터 배포

### 클러스터 아키텍처

| 노드 유형 | 대수 | 사양 | 역할 |
|----------|------|------|------|
| **Control Plane** | 3대 | 4 vCPU, 8GB RAM | 클러스터 관리 |
| **LB 전용 노드** | 6대 | 2 vCPU, 4GB RAM | 테넌트 클러스터 LB 서비스 구현 |
| **Worker Node** | 3대 | 16 vCPU, 32GB RAM | 실제 워크로드 실행 |

### Worker Node 역할

- 모니터링 스택
- 로깅 스택
- CI/CD 스택
- Cluster API 스택
- Crossplane 스택
- Container Image Registry 스택
- Code Repository 스택

### LB 전용 노드

- **토폴로지**: 모든 ESXi 호스트에 1대씩 분산 배치 (데몬셋 방식)
- **역할**: 테넌트 K8s 클러스터의 LB 서비스 생성 시 엔드포인트 구현

## 테넌트 네트워크

### 배포 방법

Crossplane이 vSphere 인프라를 제어하여 배포

### 네트워크 아키텍처

```
최상단 라우터 (OPNsense on Topton)
      │
      ▼ (DHCP로 WAN IP 할당)
┌─────────────────────────────┐
│     테넌트 라우터           │
│     (OPNsense VM)          │
│  ┌───────────────────────┐ │
│  │ WAN: DHCP (Control)   │ │
│  │ LAN1: 10.0.1.0/24     │ │
│  │ LAN2: 10.0.2.0/24     │ │
│  └───────────────────────┘ │
└─────────────────────────────┘
      │
      ▼
┌─────────────────────────────┐
│     테넌트 자원             │
│  - K8s 클러스터            │
│  - 독립 VM                 │
└─────────────────────────────┘
```

### 테넌트 라우터 사양

| 항목 | 값 |
|------|-----|
| 형태 | VMware vSphere VM |
| CPU | 2 vCPU |
| 메모리 | 4GB |
| 디스크 | 100GB |
| OS | OPNsense |
| 네트워크 | WAN, LAN1, LAN2 (3개 인터페이스) |

### 네트워크 구성

| 네트워크 | 용도 | VLAN | MTU |
|----------|------|------|-----|
| WAN | 컨트롤 플레인 연결 | 2000 (변동 가능) | 1450 |
| LAN1 | 테넌트 자원 (10.0.1.0/24) | 사용자별 동적 할당 | 1450 |
| LAN2 | 테넌트 자원 (10.0.2.0/24) | 사용자별 동적 할당 | 1450 |

## 셀프서비스 Kubernetes 클러스터

### 배포 방법

Cluster API를 통해 배포

### 네트워크 위치

테넌트 네트워크 LAN1 또는 LAN2

### IP 할당

DHCP 또는 IPAM 도입 검토 중

### Cluster API 접근성

Cluster API가 워크로드 클러스터 API에 접근하려면:
- 테넌트 라우터의 특정 포트를 포트포워딩
- Control Plane 3대/1대 구성에 따른 추가 설계 필요
- VIP + HAProxy 또는 테넌트 라우터 WAN IP 직접 사용 검토

### 워크로드 클러스터 노드 접근성

노드포트 사용 시 접근을 위한 설계:
- **플로팅 IP 개념 도입** (OpenStack 유사)
- **OPNsense VIP + BINAT 기능** 활용 (기능 테스트 완료)
- 용도:
  - 노드 SSH 접근
  - 노드포트 서비스 접근
- **VPN (WireGuard)**: 플로팅 IP에 대한 접근을 위해 사용

## 관련 문서

- [비전](vision.md) - 프로젝트 목표
- [사용자 시나리오](user-scenarios.md) - 사용자 워크플로우
- [인프라](infrastructure.md) - 하드웨어 사양
- [로드맵](roadmap.md) - Stage별 계획
