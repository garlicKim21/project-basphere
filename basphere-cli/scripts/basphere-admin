#!/bin/bash
#
# Basphere 관리자 CLI
#
# 사용법: basphere-admin <command> [options]
#
# 명령어:
#   user list                             사용자 목록
#   user show <username>                  사용자 정보 조회
#   user delete <username>                사용자 삭제
#   user pending [username]               대기 중인 등록 요청 목록/상세
#   user approve <username>               등록 요청 승인
#   user reject <username> [--reason]     등록 요청 거부
#   key pending [username]                대기 중인 키 변경 요청 목록/상세
#   key approve <username>                키 변경 요청 승인
#   key reject <username> [--reason]      키 변경 요청 거부
#

set -euo pipefail

# 공통 라이브러리 로드
source /usr/local/lib/basphere/common.sh 2>/dev/null || {
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    source "$SCRIPT_DIR/../lib/common.sh"
}

# 내부 스크립트 경로
INTERNAL_SCRIPTS="/usr/local/lib/basphere/internal"
if [[ ! -d "$INTERNAL_SCRIPTS" ]]; then
    INTERNAL_SCRIPTS="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/internal"
fi

# 버전
readonly VERSION="0.1.0"

# 사용법 출력
usage() {
    cat << EOF
Basphere 관리자 CLI v${VERSION}

사용법: basphere-admin <command> [options]

명령어:
  user list                             사용자 목록
  user show <username>                  사용자 정보 조회
  user delete <username>                사용자 삭제
  user pending [username]               대기 중인 등록 요청 목록/상세
  user approve <username>               등록 요청 승인 (계정 생성)
  user reject <username> [--reason]     등록 요청 거부

  key pending [username]                대기 중인 키 변경 요청 목록/상세
  key approve <username>                키 변경 요청 승인
  key reject <username> [--reason]      키 변경 요청 거부

옵션:
  -h, --help      도움말 출력
  -v, --version   버전 출력

예시:
  basphere-admin user list
  basphere-admin user show kimht
  basphere-admin user pending
  basphere-admin user approve kimht
  basphere-admin user reject kimht --reason "중복 요청"

  basphere-admin key pending
  basphere-admin key approve kimht
  basphere-admin key reject kimht --reason "본인 확인 실패"
EOF
    exit 0
}

# 버전 출력
version() {
    echo "basphere-admin version $VERSION"
    exit 0
}

# 템플릿 경로
TEMPLATE_DIR="/var/lib/basphere/templates/terraform"
if [[ ! -d "$TEMPLATE_DIR" ]]; then
    TEMPLATE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/../templates/terraform"
fi

# 대기 중인 요청 디렉토리
PENDING_DIR="/var/lib/basphere/pending"

# ============================================
# vSphere 폴더 관리 함수
# ============================================

# vSphere 사용자 폴더 생성
create_vsphere_user_folder() {
    local username="$1"
    local folder_dir="$BASPHERE_DATA_DIR/terraform/$username/_folder"

    log_info "vSphere 사용자 폴더 생성 중..."

    # 템플릿 파일 확인
    local template_file="$TEMPLATE_DIR/user-folder.tf.tmpl"
    if [[ ! -f "$template_file" ]]; then
        log_warn "vSphere 폴더 템플릿을 찾을 수 없습니다: $template_file"
        log_warn "vSphere 폴더는 첫 번째 VM 생성 시 수동으로 만들어야 합니다."
        return 1
    fi

    # 디렉토리 생성
    mkdir -p "$folder_dir"

    # 설정 값 로드
    local vsphere_server datacenter vm_folder
    vsphere_server=$(get_config '.vsphere.server' 'vcenter.example.local')
    datacenter=$(get_config '.vsphere.datacenter' 'DC1')
    vm_folder=$(get_config '.vsphere.folder' 'basphere-vms')

    # 타임스탬프
    local timestamp
    timestamp=$(get_timestamp)

    # 변수 치환
    sed -e "s|\${USER}|$username|g" \
        -e "s|\${TIMESTAMP}|$timestamp|g" \
        -e "s|\${VSPHERE_SERVER}|$vsphere_server|g" \
        -e "s|\${VSPHERE_ALLOW_UNVERIFIED_SSL}|true|g" \
        -e "s|\${DATACENTER}|$datacenter|g" \
        -e "s|\${VM_FOLDER}|$vm_folder|g" \
        "$template_file" > "$folder_dir/main.tf"

    # vSphere 인증 정보 파일 확인
    if [[ ! -f "$BASPHERE_VSPHERE_ENV" ]]; then
        log_warn "vSphere 인증 정보 파일을 찾을 수 없습니다: $BASPHERE_VSPHERE_ENV"
        rm -rf "$folder_dir"
        return 1
    fi

    # Terraform 실행 (서브쉘 내에서 환경변수 로드)
    (
        cd "$folder_dir"

        # 환경변수 로드
        set -a
        source "$BASPHERE_VSPHERE_ENV"
        set +a

        # terraform init
        if ! terraform init -no-color > terraform-init.log 2>&1; then
            log_warn "Terraform init 실패 (로그: $folder_dir/terraform-init.log)"
            exit 1
        fi

        # terraform apply
        if ! terraform apply -auto-approve -no-color > terraform-apply.log 2>&1; then
            log_warn "Terraform apply 실패 (로그: $folder_dir/terraform-apply.log)"
            exit 1
        fi
    )

    if [[ $? -ne 0 ]]; then
        log_warn "vSphere 폴더 생성 실패. 첫 번째 VM 생성 시 수동으로 만들어야 합니다."
        log_warn "로그 확인: $folder_dir/terraform-apply.log"
        return 1
    fi

    log_success "vSphere 사용자 폴더 생성 완료"
    return 0
}

# vSphere 사용자 폴더 삭제
delete_vsphere_user_folder() {
    local username="$1"
    local folder_dir="$BASPHERE_DATA_DIR/terraform/$username/_folder"

    if [[ ! -d "$folder_dir" ]] || [[ ! -f "$folder_dir/main.tf" ]]; then
        log_info "vSphere 폴더 정보가 없습니다 (수동 삭제 필요할 수 있음)"
        return 0
    fi

    log_info "vSphere 사용자 폴더 삭제 중..."

    # Terraform destroy (서브쉘 내에서 환경변수 로드)
    (
        cd "$folder_dir"

        # 환경변수 로드
        if [[ -f "$BASPHERE_VSPHERE_ENV" ]]; then
            set -a
            source "$BASPHERE_VSPHERE_ENV"
            set +a
        fi

        if ! terraform destroy -auto-approve -no-color > terraform-destroy.log 2>&1; then
            log_warn "vSphere 폴더 삭제 실패 (로그: $folder_dir/terraform-destroy.log)"
            exit 1
        fi
    )

    if [[ $? -ne 0 ]]; then
        log_warn "vSphere 폴더 삭제 실패"
        return 1
    fi

    rm -rf "$folder_dir"
    log_success "vSphere 사용자 폴더 삭제 완료"
    return 0
}

# ============================================
# 사용자 관리 함수
# ============================================

# 사용자 추가
user_add() {
    local username=""
    local pubkey_file=""
    local email=""
    local team=""

    # 인자 파싱
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --pubkey)
                pubkey_file="$2"
                shift 2
                ;;
            --email)
                email="$2"
                shift 2
                ;;
            --team)
                team="$2"
                shift 2
                ;;
            -*)
                log_error "알 수 없는 옵션: $1"
                exit 1
                ;;
            *)
                if [[ -z "$username" ]]; then
                    username="$1"
                fi
                shift
                ;;
        esac
    done

    # 유효성 검사
    if [[ -z "$username" ]]; then
        log_error "사용자 이름이 필요합니다"
        echo "사용법: basphere-admin user add <username> --pubkey <file>"
        exit 1
    fi

    if [[ -z "$pubkey_file" ]]; then
        log_error "공개키 파일이 필요합니다"
        echo "사용법: basphere-admin user add <username> --pubkey <file>"
        exit 1
    fi

    if [[ ! -f "$pubkey_file" ]]; then
        log_error "공개키 파일을 찾을 수 없습니다: $pubkey_file"
        exit 1
    fi

    # 사용자 이름 검증
    if ! validate_resource_name "$username" 32; then
        exit 1
    fi

    # 이미 존재하는지 확인
    if id "$username" &> /dev/null; then
        log_error "시스템 사용자가 이미 존재합니다: $username"
        exit 1
    fi

    if user_exists "$username"; then
        log_error "Basphere 사용자가 이미 존재합니다: $username"
        exit 1
    fi

    log_info "사용자 생성 중: $username"

    # 1. 시스템 사용자 생성
    useradd -m -s /bin/bash -G basphere-users "$username"
    log_success "시스템 사용자 생성 완료"

    # 2. SSH 키 설정
    local ssh_dir="/home/$username/.ssh"
    mkdir -p "$ssh_dir"
    cat "$pubkey_file" > "$ssh_dir/authorized_keys"
    chmod 700 "$ssh_dir"
    chmod 600 "$ssh_dir/authorized_keys"
    chown -R "$username:$username" "$ssh_dir"
    log_success "SSH 키 설정 완료"

    # 3. Basphere 사용자 디렉토리 생성
    local user_dir="$BASPHERE_DATA_DIR/users/$username"
    mkdir -p "$user_dir"

    # 4. 메타데이터 생성
    local timestamp
    timestamp=$(get_timestamp)

    cat > "$user_dir/metadata.json" << EOF
{
    "username": "$username",
    "email": "${email:-}",
    "team": "${team:-}",
    "created_at": "$timestamp",
    "created_by": "$(get_current_user)",
    "status": "active"
}
EOF
    log_success "메타데이터 생성 완료"

    # 5. Terraform 디렉토리 생성
    mkdir -p "$BASPHERE_DATA_DIR/terraform/$username"

    # 6. 클러스터 디렉토리 생성
    mkdir -p "$BASPHERE_DATA_DIR/clusters/$username"

    # 7. IP 블록 할당
    local block_start
    if block_start=$("$INTERNAL_SCRIPTS/allocate-block" "$username" 2>/dev/null); then
        set_user_metadata "$username" "ip_block" "$block_start"
        log_success "IP 블록 할당 완료: $block_start"
    else
        log_warn "IP 블록 할당 실패 (나중에 수동 할당 필요)"
    fi

    # 8. vSphere 사용자 폴더 생성
    local folder_path=""
    if create_vsphere_user_folder "$username"; then
        folder_path=$(get_config '.vsphere.folder' 'basphere-vms')
        folder_path="${folder_path}/${username}"
        set_user_metadata "$username" "vsphere_folder" "$folder_path"
    fi

    # 9. 권한 설정
    chown -R basphere:basphere "$user_dir"
    chmod 755 "$user_dir"
    chmod 644 "$user_dir/metadata.json"

    chown -R basphere:basphere "$BASPHERE_DATA_DIR/terraform/$username"
    chmod 777 "$BASPHERE_DATA_DIR/terraform/$username"

    chown -R basphere:basphere "$BASPHERE_DATA_DIR/clusters/$username"
    chmod 777 "$BASPHERE_DATA_DIR/clusters/$username"

    # 감사 로그
    audit_log "USER_ADD" "$username" "pubkey_file=$pubkey_file"

    echo ""
    log_success "사용자 생성 완료: $username"
    echo ""
    echo "사용자 정보:"
    echo "  - 사용자명: $username"
    echo "  - IP 블록: ${block_start:-할당되지 않음}"
    echo "  - SSH: ssh $username@<bastion-host>"
}

# 사용자 목록
user_list() {
    local users_dir="$BASPHERE_DATA_DIR/users"

    if [[ ! -d "$users_dir" ]] || [[ -z "$(ls -A "$users_dir" 2>/dev/null)" ]]; then
        echo "등록된 사용자가 없습니다."
        exit 0
    fi

    print_table_header "%-10s %-22s %-10s %-26s %-3s %-8s %s" "USERNAME" "EMAIL" "TEAM" "IP_BLOCK" "VMs" "STATUS" "CREATED"

    for user_dir in "$users_dir"/*/; do
        [[ ! -d "$user_dir" ]] && continue

        local username
        username=$(basename "$user_dir")

        local metadata_file="$user_dir/metadata.json"

        if [[ -f "$metadata_file" ]]; then
            local email team ip_block_start ip_block_range created_at status vm_count

            email=$(jq -r '.email // "-"' "$metadata_file")
            team=$(jq -r '.team // "-"' "$metadata_file")
            # 빈 문자열인 경우 "-"로 표시
            [[ -z "$email" ]] && email="-"
            [[ -z "$team" ]] && team="-"
            ip_block_start=$(jq -r '.ip_block // "-"' "$metadata_file")
            ip_block_range=$(format_ip_block_range "$ip_block_start")
            created_at=$(jq -r '.created_at // "-"' "$metadata_file" | cut -d'T' -f1)
            status=$(jq -r '.status // "active"' "$metadata_file")

            # VM 개수 (_folder 디렉토리 제외)
            local tf_dir="$BASPHERE_DATA_DIR/terraform/$username"
            if [[ -d "$tf_dir" ]]; then
                vm_count=$(find "$tf_dir" -mindepth 1 -maxdepth 1 -type d ! -name "_folder" 2>/dev/null | wc -l | tr -d ' ')
            else
                vm_count=0
            fi

            print_table_row "%-10s %-22s %-10s %-26s %-3s %-8s %s" "$username" "$email" "$team" "$ip_block_range" "$vm_count" "$status" "$created_at"
        fi
    done
}

# 사용자 정보 조회
user_show() {
    local username="${1:-}"

    if [[ -z "$username" ]]; then
        log_error "사용자 이름이 필요합니다"
        echo "사용법: basphere-admin user show <username>"
        exit 1
    fi

    if ! user_exists "$username"; then
        log_error "사용자를 찾을 수 없습니다: $username"
        exit 1
    fi

    local user_dir="$BASPHERE_DATA_DIR/users/$username"
    local metadata_file="$user_dir/metadata.json"

    echo "=== 사용자 정보: $username ==="
    echo ""

    if [[ -f "$metadata_file" ]]; then
        echo "기본 정보:"
        # ip_block은 범위로 표시
        local ip_block_start
        ip_block_start=$(jq -r '.ip_block // ""' "$metadata_file")

        jq -r '. | to_entries[] | select(.key != "ip_block") | "  \(.key): \(.value)"' "$metadata_file"

        if [[ -n "$ip_block_start" && "$ip_block_start" != "null" ]]; then
            echo "  ip_block: $(format_ip_block_range "$ip_block_start")"
        fi
    fi

    echo ""
    echo "리소스 현황:"

    # VM 개수 (_folder 디렉토리 제외)
    local tf_dir="$BASPHERE_DATA_DIR/terraform/$username"
    local vm_count=0
    if [[ -d "$tf_dir" ]]; then
        vm_count=$(find "$tf_dir" -mindepth 1 -maxdepth 1 -type d ! -name "_folder" 2>/dev/null | wc -l | tr -d ' ')
    fi
    echo "  VMs: $vm_count"

    # 클러스터 개수
    local cluster_dir="$BASPHERE_DATA_DIR/clusters/$username"
    local cluster_count=0
    if [[ -d "$cluster_dir" ]]; then
        cluster_count=$(find "$cluster_dir" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | wc -l | tr -d ' ')
    fi
    echo "  Clusters: $cluster_count"

    # IP 사용량
    echo ""
    echo "IP 할당 현황:"
    "$INTERNAL_SCRIPTS/list-user-ips" "$username" 2>/dev/null || echo "  정보 없음"
}

# 사용자 삭제
user_delete() {
    local username="${1:-}"

    if [[ -z "$username" ]]; then
        log_error "사용자 이름이 필요합니다"
        echo "사용법: basphere-admin user delete <username>"
        exit 1
    fi

    if ! user_exists "$username"; then
        log_error "사용자를 찾을 수 없습니다: $username"
        exit 1
    fi

    # 리소스 확인 (_folder 디렉토리 제외)
    local tf_dir="$BASPHERE_DATA_DIR/terraform/$username"
    local vm_count=0
    if [[ -d "$tf_dir" ]]; then
        vm_count=$(find "$tf_dir" -mindepth 1 -maxdepth 1 -type d ! -name "_folder" 2>/dev/null | wc -l | tr -d ' ')
    fi

    if [[ $vm_count -gt 0 ]]; then
        log_error "사용자에게 $vm_count개의 VM이 있습니다. 먼저 VM을 삭제하세요."
        exit 1
    fi

    # 확인
    if ! prompt_confirm "정말로 사용자 '$username'을(를) 삭제하시겠습니까?"; then
        log_info "취소되었습니다"
        exit 0
    fi

    log_info "사용자 삭제 중: $username"

    # 1. vSphere 사용자 폴더 삭제
    delete_vsphere_user_folder "$username"

    # 2. Basphere 데이터 삭제
    rm -rf "$BASPHERE_DATA_DIR/users/$username"
    rm -rf "$BASPHERE_DATA_DIR/terraform/$username"
    rm -rf "$BASPHERE_DATA_DIR/clusters/$username"
    log_success "Basphere 데이터 삭제 완료"

    # 3. IP 블록 정보는 유지 (allocations.tsv에서 제거하지 않음 - 재할당 방지)
    log_info "IP 블록 정보는 유지됩니다 (재할당 방지)"

    # 4. 시스템 사용자 삭제
    if id "$username" &> /dev/null; then
        userdel -r "$username" 2>/dev/null || userdel "$username"
        log_success "시스템 사용자 삭제 완료"
    fi

    # 감사 로그
    audit_log "USER_DELETE" "$username" ""

    log_success "사용자 삭제 완료: $username"
}

# 대기 중인 요청 목록/상세
user_pending() {
    local username="${1:-}"

    # pending 디렉토리 확인
    if [[ ! -d "$PENDING_DIR" ]]; then
        echo "대기 중인 등록 요청이 없습니다."
        exit 0
    fi

    # 특정 사용자 상세 조회
    if [[ -n "$username" ]]; then
        local found=false
        for req_file in "$PENDING_DIR"/*.json; do
            [[ ! -f "$req_file" ]] && continue
            local req_username
            req_username=$(jq -r '.username' "$req_file" 2>/dev/null)
            if [[ "$req_username" == "$username" ]]; then
                local status
                status=$(jq -r '.status' "$req_file")
                if [[ "$status" == "pending" ]]; then
                    echo "=== 등록 요청 상세: $username ==="
                    echo ""
                    echo "요청 ID: $(jq -r '.id' "$req_file")"
                    echo "사용자명: $req_username"
                    echo "이메일: $(jq -r '.email' "$req_file")"
                    echo "소속: $(jq -r '.team // "-"' "$req_file")"
                    echo "요청일: $(jq -r '.created_at' "$req_file")"
                    echo ""
                    echo "공개키:"
                    jq -r '.public_key' "$req_file"
                    found=true
                    break
                fi
            fi
        done

        if [[ "$found" == false ]]; then
            log_error "대기 중인 요청을 찾을 수 없습니다: $username"
            exit 1
        fi
        return
    fi

    # 전체 목록 조회
    local count=0
    local pending_list=""

    for req_file in "$PENDING_DIR"/*.json; do
        [[ ! -f "$req_file" ]] && continue
        local status
        status=$(jq -r '.status' "$req_file" 2>/dev/null)
        if [[ "$status" == "pending" ]]; then
            ((count++)) || true
            local uname email team created_at
            uname=$(jq -r '.username' "$req_file")
            email=$(jq -r '.email' "$req_file")
            team=$(jq -r '.team // "-"' "$req_file")
            created_at=$(jq -r '.created_at' "$req_file" | cut -d'T' -f1)
            pending_list+="$uname|$email|$team|$created_at\n"
        fi
    done

    if [[ $count -eq 0 ]]; then
        echo "대기 중인 등록 요청이 없습니다."
        exit 0
    fi

    echo "대기 중인 등록 요청 (${count}건)"
    echo ""
    print_table_header "%-15s %-25s %-15s %s" "USERNAME" "EMAIL" "TEAM" "CREATED"
    echo -e "$pending_list" | while IFS='|' read -r uname email team created_at; do
        [[ -z "$uname" ]] && continue
        print_table_row "%-15s %-25s %-15s %s" "$uname" "$email" "$team" "$created_at"
    done
}

# 등록 요청 승인
user_approve() {
    local username="${1:-}"

    if [[ -z "$username" ]]; then
        log_error "사용자 이름이 필요합니다"
        echo "사용법: basphere-admin user approve <username>"
        exit 1
    fi

    # 요청 파일 찾기
    local req_file=""
    for f in "$PENDING_DIR"/*.json; do
        [[ ! -f "$f" ]] && continue
        local req_username status
        req_username=$(jq -r '.username' "$f" 2>/dev/null)
        status=$(jq -r '.status' "$f" 2>/dev/null)
        if [[ "$req_username" == "$username" ]] && [[ "$status" == "pending" ]]; then
            req_file="$f"
            break
        fi
    done

    if [[ -z "$req_file" ]]; then
        log_error "대기 중인 요청을 찾을 수 없습니다: $username"
        exit 1
    fi

    # 이미 시스템 사용자가 존재하는지 확인
    if id "$username" &> /dev/null; then
        log_error "시스템 사용자가 이미 존재합니다: $username"
        exit 1
    fi

    # 요청 정보 추출
    local public_key email team
    public_key=$(jq -r '.public_key' "$req_file")
    email=$(jq -r '.email // ""' "$req_file")
    team=$(jq -r '.team // ""' "$req_file")

    # 임시 파일에 공개키 저장
    local temp_pubkey="/tmp/basphere-approve-$username.pub"
    echo "$public_key" > "$temp_pubkey"

    log_info "등록 요청 승인 중: $username"

    # user_add 함수 호출 (email, team 포함)
    local add_args=("$username" --pubkey "$temp_pubkey")
    [[ -n "$email" ]] && add_args+=(--email "$email")
    [[ -n "$team" ]] && add_args+=(--team "$team")

    if user_add "${add_args[@]}"; then
        # 요청 상태 업데이트
        local timestamp
        timestamp=$(get_timestamp)
        jq --arg by "$(get_current_user)" --arg at "$timestamp" \
           '.status = "approved" | .processed_by = $by | .processed_at = $at' \
           "$req_file" > "$req_file.tmp" && mv "$req_file.tmp" "$req_file"

        log_success "등록 요청 승인 완료: $username"
    else
        log_error "사용자 생성 실패"
        rm -f "$temp_pubkey"
        exit 1
    fi

    rm -f "$temp_pubkey"
}

# 등록 요청 거부
user_reject() {
    local username=""
    local reason=""

    # 인자 파싱
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --reason)
                reason="$2"
                shift 2
                ;;
            -*)
                log_error "알 수 없는 옵션: $1"
                exit 1
                ;;
            *)
                if [[ -z "$username" ]]; then
                    username="$1"
                fi
                shift
                ;;
        esac
    done

    if [[ -z "$username" ]]; then
        log_error "사용자 이름이 필요합니다"
        echo "사용법: basphere-admin user reject <username> [--reason <reason>]"
        exit 1
    fi

    # 요청 파일 찾기
    local req_file=""
    for f in "$PENDING_DIR"/*.json; do
        [[ ! -f "$f" ]] && continue
        local req_username status
        req_username=$(jq -r '.username' "$f" 2>/dev/null)
        status=$(jq -r '.status' "$f" 2>/dev/null)
        if [[ "$req_username" == "$username" ]] && [[ "$status" == "pending" ]]; then
            req_file="$f"
            break
        fi
    done

    if [[ -z "$req_file" ]]; then
        log_error "대기 중인 요청을 찾을 수 없습니다: $username"
        exit 1
    fi

    # 확인
    if ! prompt_confirm "정말로 '$username'의 등록 요청을 거부하시겠습니까?"; then
        log_info "취소되었습니다"
        exit 0
    fi

    # 요청 상태 업데이트
    local timestamp
    timestamp=$(get_timestamp)
    jq --arg by "$(get_current_user)" --arg at "$timestamp" --arg reason "$reason" \
       '.status = "rejected" | .processed_by = $by | .processed_at = $at | .reject_reason = $reason' \
       "$req_file" > "$req_file.tmp" && mv "$req_file.tmp" "$req_file"

    audit_log "USER_REJECT" "$username" "reason=$reason"

    log_success "등록 요청 거부됨: $username"
    if [[ -n "$reason" ]]; then
        echo "사유: $reason"
    fi
}

# ============================================
# SSH 키 변경 관리 함수
# ============================================

# 키 변경 요청 디렉토리
KEY_CHANGE_DIR="/var/lib/basphere/pending/key-changes"

# 대기 중인 키 변경 요청 목록/상세
key_pending() {
    local username="${1:-}"

    if [[ ! -d "$KEY_CHANGE_DIR" ]] || [[ -z "$(ls -A "$KEY_CHANGE_DIR" 2>/dev/null)" ]]; then
        echo "대기 중인 키 변경 요청이 없습니다."
        exit 0
    fi

    # 특정 사용자 상세 조회
    if [[ -n "$username" ]]; then
        local found=false
        for req_file in "$KEY_CHANGE_DIR"/*.json; do
            [[ ! -f "$req_file" ]] && continue
            local req_username status
            req_username=$(jq -r '.username' "$req_file" 2>/dev/null)
            status=$(jq -r '.status' "$req_file" 2>/dev/null)
            if [[ "$req_username" == "$username" ]] && [[ "$status" == "pending" ]]; then
                echo "=== 키 변경 요청 상세: $username ==="
                echo ""
                echo "요청 ID: $(jq -r '.id' "$req_file")"
                echo "사용자명: $req_username"
                echo "이메일: $(jq -r '.email' "$req_file")"
                echo "변경 사유: $(jq -r '.reason // "-"' "$req_file")"
                echo "요청일: $(jq -r '.created_at' "$req_file")"
                echo ""
                echo "새 공개키:"
                jq -r '.new_public_key' "$req_file"
                found=true
                break
            fi
        done

        if [[ "$found" == false ]]; then
            log_error "대기 중인 키 변경 요청을 찾을 수 없습니다: $username"
            exit 1
        fi
        return
    fi

    # 전체 목록 조회
    local count=0
    local pending_list=""

    for req_file in "$KEY_CHANGE_DIR"/*.json; do
        [[ ! -f "$req_file" ]] && continue
        local status
        status=$(jq -r '.status' "$req_file" 2>/dev/null)
        if [[ "$status" == "pending" ]]; then
            ((count++)) || true
            local uname email reason created_at
            uname=$(jq -r '.username' "$req_file")
            email=$(jq -r '.email' "$req_file")
            reason=$(jq -r '.reason // "-"' "$req_file")
            created_at=$(jq -r '.created_at' "$req_file" | cut -d'T' -f1)
            pending_list+="$uname|$email|$reason|$created_at\n"
        fi
    done

    if [[ $count -eq 0 ]]; then
        echo "대기 중인 키 변경 요청이 없습니다."
        exit 0
    fi

    echo "대기 중인 키 변경 요청 (${count}건)"
    echo ""
    print_table_header "%-15s %-25s %-20s %s" "USERNAME" "EMAIL" "REASON" "CREATED"
    echo -e "$pending_list" | while IFS='|' read -r uname email reason created_at; do
        [[ -z "$uname" ]] && continue
        print_table_row "%-15s %-25s %-20s %s" "$uname" "$email" "$reason" "$created_at"
    done
}

# 키 변경 요청 승인
key_approve() {
    local username="${1:-}"

    if [[ -z "$username" ]]; then
        log_error "사용자 이름이 필요합니다"
        echo "사용법: basphere-admin key approve <username>"
        exit 1
    fi

    # 요청 파일 찾기
    local req_file=""
    for f in "$KEY_CHANGE_DIR"/*.json; do
        [[ ! -f "$f" ]] && continue
        local req_username status
        req_username=$(jq -r '.username' "$f" 2>/dev/null)
        status=$(jq -r '.status' "$f" 2>/dev/null)
        if [[ "$req_username" == "$username" ]] && [[ "$status" == "pending" ]]; then
            req_file="$f"
            break
        fi
    done

    if [[ -z "$req_file" ]]; then
        log_error "대기 중인 키 변경 요청을 찾을 수 없습니다: $username"
        exit 1
    fi

    # 사용자 존재 확인
    if ! id "$username" &> /dev/null; then
        log_error "시스템 사용자가 존재하지 않습니다: $username"
        exit 1
    fi

    # 새 공개키 추출
    local new_public_key
    new_public_key=$(jq -r '.new_public_key' "$req_file")

    log_info "키 변경 요청 승인 중: $username"

    # SSH 키 업데이트
    local ssh_dir="/home/$username/.ssh"
    echo "$new_public_key" > "$ssh_dir/authorized_keys"
    chmod 600 "$ssh_dir/authorized_keys"
    chown "$username:$username" "$ssh_dir/authorized_keys"
    log_success "SSH 키 업데이트 완료"

    # 요청 상태 업데이트
    local timestamp
    timestamp=$(get_timestamp)
    jq --arg by "$(get_current_user)" --arg at "$timestamp" \
       '.status = "approved" | .processed_by = $by | .processed_at = $at' \
       "$req_file" > "$req_file.tmp" && mv "$req_file.tmp" "$req_file"

    audit_log "KEY_APPROVE" "$username" ""

    log_success "키 변경 요청 승인 완료: $username"
}

# 키 변경 요청 거부
key_reject() {
    local username=""
    local reason=""

    # 인자 파싱
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --reason)
                reason="$2"
                shift 2
                ;;
            -*)
                log_error "알 수 없는 옵션: $1"
                exit 1
                ;;
            *)
                if [[ -z "$username" ]]; then
                    username="$1"
                fi
                shift
                ;;
        esac
    done

    if [[ -z "$username" ]]; then
        log_error "사용자 이름이 필요합니다"
        echo "사용법: basphere-admin key reject <username> [--reason <reason>]"
        exit 1
    fi

    # 요청 파일 찾기
    local req_file=""
    for f in "$KEY_CHANGE_DIR"/*.json; do
        [[ ! -f "$f" ]] && continue
        local req_username status
        req_username=$(jq -r '.username' "$f" 2>/dev/null)
        status=$(jq -r '.status' "$f" 2>/dev/null)
        if [[ "$req_username" == "$username" ]] && [[ "$status" == "pending" ]]; then
            req_file="$f"
            break
        fi
    done

    if [[ -z "$req_file" ]]; then
        log_error "대기 중인 키 변경 요청을 찾을 수 없습니다: $username"
        exit 1
    fi

    # 확인
    if ! prompt_confirm "정말로 '$username'의 키 변경 요청을 거부하시겠습니까?"; then
        log_info "취소되었습니다"
        exit 0
    fi

    # 요청 상태 업데이트
    local timestamp
    timestamp=$(get_timestamp)
    jq --arg by "$(get_current_user)" --arg at "$timestamp" --arg reason "$reason" \
       '.status = "rejected" | .processed_by = $by | .processed_at = $at | .reject_reason = $reason' \
       "$req_file" > "$req_file.tmp" && mv "$req_file.tmp" "$req_file"

    audit_log "KEY_REJECT" "$username" "reason=$reason"

    log_success "키 변경 요청 거부됨: $username"
    if [[ -n "$reason" ]]; then
        echo "사유: $reason"
    fi
}

# ============================================
# 메인 함수
# ============================================

main() {
    # Root 권한 확인
    if [[ $EUID -ne 0 ]]; then
        log_error "이 명령은 root 권한이 필요합니다"
        log_info "사용법: sudo basphere-admin <command>"
        exit 1
    fi

    # 인자 없으면 도움말
    if [[ $# -eq 0 ]]; then
        usage
    fi

    local command="${1:-}"
    shift

    case "$command" in
        -h|--help)
            usage
            ;;
        -v|--version)
            version
            ;;
        user)
            local subcommand="${1:-}"
            shift || true

            case "$subcommand" in
                add)
                    user_add "$@"
                    ;;
                list)
                    user_list "$@"
                    ;;
                show)
                    user_show "$@"
                    ;;
                delete)
                    user_delete "$@"
                    ;;
                pending)
                    user_pending "$@"
                    ;;
                approve)
                    user_approve "$@"
                    ;;
                reject)
                    user_reject "$@"
                    ;;
                *)
                    log_error "알 수 없는 user 명령: $subcommand"
                    echo "사용 가능한 명령: add, list, show, delete, pending, approve, reject"
                    exit 1
                    ;;
            esac
            ;;
        key)
            local subcommand="${1:-}"
            shift || true

            case "$subcommand" in
                pending)
                    key_pending "$@"
                    ;;
                approve)
                    key_approve "$@"
                    ;;
                reject)
                    key_reject "$@"
                    ;;
                *)
                    log_error "알 수 없는 key 명령: $subcommand"
                    echo "사용 가능한 명령: pending, approve, reject"
                    exit 1
                    ;;
            esac
            ;;
        *)
            log_error "알 수 없는 명령: $command"
            usage
            ;;
    esac
}

main "$@"
