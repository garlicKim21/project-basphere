#!/bin/bash
#
# VM 생성 스크립트 (사용자용)
#
# 사용법: create-vm
#

set -euo pipefail

# 공통 라이브러리 로드
source /usr/local/lib/basphere/common.sh 2>/dev/null || {
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    source "$SCRIPT_DIR/../../lib/common.sh"
}

# 내부 스크립트 경로
INTERNAL_SCRIPTS="/usr/local/lib/basphere/internal"
if [[ ! -d "$INTERNAL_SCRIPTS" ]]; then
    INTERNAL_SCRIPTS="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/../internal"
fi

# 템플릿 경로
TEMPLATE_DIR="/var/lib/basphere/templates/terraform"
if [[ ! -d "$TEMPLATE_DIR" ]]; then
    TEMPLATE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/../../templates/terraform"
fi

# 현재 사용자
CURRENT_USER=$(get_current_user)

# 사용법
usage() {
    cat << EOF
VM 생성

사용법: create-vm [옵션]

옵션:
  -n, --name <name>     VM 이름 (대화형 입력 가능)
  -o, --os <os>         OS 종류 (ubuntu-24.04, rocky-10)
  -s, --spec <spec>     스펙 (small, medium, large)
  -c, --count <count>   생성할 VM 수 (기본값: 1)
  -h, --help            도움말

예시:
  create-vm                                    # 대화형 모드
  create-vm -n my-server -o ubuntu-24.04 -s medium   # 명령행 모드
  create-vm -n web -o rocky-10 -s small -c 3         # 3대 생성
EOF
    exit 0
}

# OS 목록 가져오기
get_os_list() {
    yq eval '.templates.os | keys | .[]' "$BASPHERE_CONFIG" 2>/dev/null
}

# OS 설명 가져오기
get_os_description() {
    local os="$1"
    get_config ".templates.os.$os.description" "$os"
}

# OS 템플릿 이름 가져오기
get_os_template() {
    local os="$1"
    get_config ".templates.os.$os.template" ""
}

# OS 기본 사용자 가져오기
get_os_default_user() {
    local os="$1"
    get_config ".templates.os.$os.default_user" "ubuntu"
}

# OS 유효성 검사
validate_os() {
    local os="$1"
    local template
    template=$(get_os_template "$os")
    [[ -n "$template" ]]
}

# VM 스펙 목록 가져오기
get_vm_specs() {
    local specs_file="/etc/basphere/specs.yaml"

    if [[ ! -f "$specs_file" ]]; then
        echo "small medium large"
        return
    fi

    yq eval '.vm_specs | keys | .[]' "$specs_file" 2>/dev/null | tr '\n' ' '
}

# 스펙 상세 정보 가져오기
get_spec_details() {
    local spec="$1"
    local cpu memory disk description

    cpu=$(get_spec ".vm_specs.$spec.cpu" "2")
    memory=$(get_spec ".vm_specs.$spec.memory_mb" "4096")
    disk=$(get_spec ".vm_specs.$spec.disk_gb" "50")
    description=$(get_spec ".vm_specs.$spec.description" "")

    local memory_gb=$((memory / 1024))
    echo "$cpu vCPU, ${memory_gb}GB RAM, ${disk}GB Disk"
}

# 사용자 SSH 공개키 가져오기
get_user_ssh_key() {
    local user="$1"
    local ssh_key_file="/home/$user/.ssh/authorized_keys"

    if [[ -f "$ssh_key_file" ]]; then
        head -1 "$ssh_key_file"
    else
        log_warn "SSH 공개키를 찾을 수 없습니다"
        echo ""
    fi
}

# Terraform 파일 생성
generate_terraform_file() {
    local vm_name="$1"
    local os_type="$2"
    local spec="$3"
    local ip_address="$4"
    local user="$5"
    local output_dir="$6"

    local template_file="$TEMPLATE_DIR/vm.tf.tmpl"

    if [[ ! -f "$template_file" ]]; then
        log_error "Terraform 템플릿을 찾을 수 없습니다: $template_file"
        return 1
    fi

    # 설정 값 로드
    local vsphere_server datacenter cluster datastore network resource_pool vm_folder template default_user
    vsphere_server=$(get_config '.vsphere.server' 'vcenter.example.local')
    datacenter=$(get_config '.vsphere.datacenter' 'DC1')
    cluster=$(get_config '.vsphere.cluster' 'Cluster1')
    datastore=$(get_config '.vsphere.datastore' 'datastore1')
    network=$(get_config '.vsphere.network' 'VM Network')
    resource_pool=$(get_config '.vsphere.resource_pool' '/DC1/host/Cluster1/Resources')
    vm_folder=$(get_config '.vsphere.folder' 'basphere-vms')

    # OS별 설정
    template=$(get_os_template "$os_type")
    default_user=$(get_os_default_user "$os_type")

    # 네트워크 설정
    local gateway netmask dns_servers network_prefix mtu
    gateway=$(get_config '.network.gateway' '10.254.0.1')
    netmask=$(get_config '.network.netmask' '255.255.248.0')
    network_prefix=$(get_config '.network.prefix_length' '21')
    mtu=$(get_config '.network.mtu' '1500')

    # DNS 서버 (JSON 배열 형식으로 변환)
    dns_servers=$(get_config '.network.dns[]' '8.8.8.8' | while read -r dns; do echo "\"$dns\""; done | paste -sd ',' -)

    # 스펙 정보
    local num_cpus memory_mb disk_gb
    num_cpus=$(get_spec ".vm_specs.$spec.cpu" "2")
    memory_mb=$(get_spec ".vm_specs.$spec.memory_mb" "4096")
    disk_gb=$(get_spec ".vm_specs.$spec.disk_gb" "50")

    # SSH 키
    local ssh_public_key
    ssh_public_key=$(get_user_ssh_key "$user")

    # 타임스탬프
    local timestamp
    timestamp=$(get_timestamp)

    # vSphere VM 이름 (사용자 프리픽스 포함 - vSphere에서 고유해야 함)
    local vsphere_vm_name="${user}-${vm_name}"

    # 변수 치환
    sed -e "s|\${VM_NAME}|$vm_name|g" \
        -e "s|\${VSPHERE_VM_NAME}|$vsphere_vm_name|g" \
        -e "s|\${USER}|$user|g" \
        -e "s|\${TIMESTAMP}|$timestamp|g" \
        -e "s|\${VSPHERE_SERVER}|$vsphere_server|g" \
        -e "s|\${VSPHERE_ALLOW_UNVERIFIED_SSL}|true|g" \
        -e "s|\${DATACENTER}|$datacenter|g" \
        -e "s|\${CLUSTER}|$cluster|g" \
        -e "s|\${DATASTORE}|$datastore|g" \
        -e "s|\${NETWORK}|$network|g" \
        -e "s|\${RESOURCE_POOL}|$resource_pool|g" \
        -e "s|\${VM_FOLDER}|$vm_folder|g" \
        -e "s|\${TEMPLATE}|$template|g" \
        -e "s|\${DEFAULT_USER}|$default_user|g" \
        -e "s|\${NUM_CPUS}|$num_cpus|g" \
        -e "s|\${MEMORY_MB}|$memory_mb|g" \
        -e "s|\${DISK_GB}|$disk_gb|g" \
        -e "s|\${IP_ADDRESS}|$ip_address|g" \
        -e "s|\${NETMASK}|$netmask|g" \
        -e "s|\${GATEWAY}|$gateway|g" \
        -e "s|\${DNS_SERVERS}|$dns_servers|g" \
        -e "s|\${NETWORK_PREFIX}|$network_prefix|g" \
        -e "s|\${MTU}|$mtu|g" \
        -e "s|\${SSH_PUBLIC_KEY}|$ssh_public_key|g" \
        "$template_file" > "$output_dir/main.tf"
}

# VM 생성 실행
create_single_vm() {
    local vm_name="$1"
    local os_type="$2"
    local spec="$3"
    local user="$4"

    log_info "VM 생성 준비 중: $vm_name ($os_type, $spec)"

    # Terraform 디렉토리
    local tf_dir="$BASPHERE_DATA_DIR/terraform/$user/$vm_name"

    # 이미 존재하는지 확인
    if [[ -d "$tf_dir" ]]; then
        log_error "VM이 이미 존재합니다: $vm_name"
        return 1
    fi

    # IP 할당
    local ip_address
    if ! ip_address=$("$INTERNAL_SCRIPTS/allocate-ip" "$user" "$vm_name" "vm" 2>/dev/null); then
        log_error "IP 할당 실패"
        return 1
    fi

    log_success "IP 할당: $ip_address"

    # Terraform 디렉토리 생성
    mkdir -p "$tf_dir"

    # Terraform 파일 생성
    if ! generate_terraform_file "$vm_name" "$os_type" "$spec" "$ip_address" "$user" "$tf_dir"; then
        # 실패 시 IP 반환
        "$INTERNAL_SCRIPTS/release-ip" "$ip_address" "$user" 2>/dev/null || true
        rm -rf "$tf_dir"
        return 1
    fi

    # vSphere VM 이름 (사용자 프리픽스 포함)
    local vsphere_vm_name="${user}-${vm_name}"

    # OS 기본 사용자
    local default_user
    default_user=$(get_os_default_user "$os_type")

    # 메타데이터 생성
    cat > "$tf_dir/metadata.json" << EOF
{
    "name": "$vm_name",
    "vsphere_vm_name": "$vsphere_vm_name",
    "owner": "$user",
    "os": "$os_type",
    "default_user": "$default_user",
    "spec": "$spec",
    "ip_address": "$ip_address",
    "created_at": "$(get_timestamp)",
    "status": "creating"
}
EOF

    # vSphere 인증 정보 파일 확인
    if [[ ! -f "$BASPHERE_VSPHERE_ENV" ]]; then
        log_error "vSphere 인증 정보 파일을 찾을 수 없습니다: $BASPHERE_VSPHERE_ENV"
        "$INTERNAL_SCRIPTS/release-ip" "$ip_address" "$user" 2>/dev/null || true
        rm -rf "$tf_dir"
        return 1
    fi

    # Terraform 실행 (서브쉘 내에서 환경변수 로드)
    log_info "VM 생성 중... (몇 분 소요될 수 있습니다)"

    (
        cd "$tf_dir"

        # 환경변수 로드
        set -a
        source "$BASPHERE_VSPHERE_ENV"
        set +a

        # terraform init
        if ! terraform init -no-color > terraform-init.log 2>&1; then
            log_error "Terraform init 실패 (로그: $tf_dir/terraform-init.log)"
            exit 1
        fi

        # terraform apply
        if ! terraform apply -auto-approve -no-color > terraform-apply.log 2>&1; then
            log_error "Terraform apply 실패 (로그: $tf_dir/terraform-apply.log)"
            exit 1
        fi
    )

    if [[ $? -ne 0 ]]; then
        # 실패 시 정리
        jq '.status = "failed"' "$tf_dir/metadata.json" > "$tf_dir/metadata.json.tmp" && \
            mv "$tf_dir/metadata.json.tmp" "$tf_dir/metadata.json"
        return 1
    fi

    # 성공 - 메타데이터 업데이트
    jq '.status = "running"' "$tf_dir/metadata.json" > "$tf_dir/metadata.json.tmp" && \
        mv "$tf_dir/metadata.json.tmp" "$tf_dir/metadata.json"

    # 감사 로그
    audit_log "CREATE_VM" "$vm_name" "user=$user,os=$os_type,spec=$spec,ip=$ip_address"

    log_success "VM 생성 완료: $vm_name ($ip_address)"
    return 0
}

# 메인 함수
main() {
    local vm_name=""
    local os_type=""
    local spec=""
    local count=1

    # 인자 파싱
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -n|--name)
                vm_name="$2"
                shift 2
                ;;
            -o|--os)
                os_type="$2"
                shift 2
                ;;
            -s|--spec)
                spec="$2"
                shift 2
                ;;
            -c|--count)
                count="$2"
                shift 2
                ;;
            -h|--help)
                usage
                ;;
            *)
                log_error "알 수 없는 옵션: $1"
                usage
                ;;
        esac
    done

    # 사용자 확인
    if ! user_exists "$CURRENT_USER"; then
        log_error "Basphere 사용자가 아닙니다: $CURRENT_USER"
        log_info "관리자에게 계정 생성을 요청하세요"
        exit 1
    fi

    echo ""
    echo "=== VM 생성 ==="
    echo ""

    # 1. VM 이름 입력
    if [[ -z "$vm_name" ]]; then
        vm_name=$(prompt_input "VM 이름")

        if ! validate_resource_name "$vm_name"; then
            exit 1
        fi
    fi

    # 이름 중복 확인
    if vm_name_exists "$CURRENT_USER" "$vm_name"; then
        log_error "이미 존재하는 VM 이름입니다: $vm_name"
        exit 1
    fi

    # 2. OS 선택 (필수)
    if [[ -z "$os_type" ]]; then
        echo ""
        local os_list
        os_list=$(get_os_list)

        if [[ -z "$os_list" ]]; then
            log_error "사용 가능한 OS가 설정되지 않았습니다"
            log_info "관리자에게 문의하세요"
            exit 1
        fi

        local os_array=()
        while IFS= read -r os; do
            [[ -n "$os" ]] && os_array+=("$os")
        done <<< "$os_list"

        local os_options=()
        for os in "${os_array[@]}"; do
            local desc
            desc=$(get_os_description "$os")
            os_options+=("$os - $desc")
        done

        local os_selection
        os_selection=$(prompt_select "OS 선택" "${os_options[@]}")
        os_type="${os_array[$os_selection]}"
    else
        # 명령행에서 OS 지정 시 유효성 검사
        if ! validate_os "$os_type"; then
            log_error "지원하지 않는 OS입니다: $os_type"
            log_info "사용 가능한 OS: $(get_os_list | tr '\n' ' ')"
            exit 1
        fi
    fi

    # 3. 스펙 선택
    if [[ -z "$spec" ]]; then
        echo ""
        local specs_list
        specs_list=$(get_vm_specs)
        local specs_array=($specs_list)

        local options=()
        for s in "${specs_array[@]}"; do
            local details
            details=$(get_spec_details "$s")
            options+=("$s - $details")
        done

        local selection
        selection=$(prompt_select "스펙 선택" "${options[@]}")
        spec="${specs_array[$selection]}"
    fi

    # 4. 대수 입력
    if [[ $count -eq 1 ]]; then
        echo ""
        count=$(prompt_number "생성할 VM 대수" 1 1 10)
    fi

    # Quota 확인 (_folder 디렉토리 제외)
    local max_vms current_vms
    max_vms=$(get_config '.quotas.default.max_vms' '10')
    current_vms=0
    if [[ -d "$BASPHERE_DATA_DIR/terraform/$CURRENT_USER" ]]; then
        current_vms=$(find "$BASPHERE_DATA_DIR/terraform/$CURRENT_USER" -mindepth 1 -maxdepth 1 -type d ! -name "_folder" 2>/dev/null | wc -l | tr -d ' ')
    fi

    if [[ $((current_vms + count)) -gt $max_vms ]]; then
        log_error "VM 할당량을 초과합니다 (현재: $current_vms, 요청: $count, 최대: $max_vms)"
        exit 1
    fi

    # 확인
    local default_user
    default_user=$(get_os_default_user "$os_type")

    echo ""
    echo "생성할 VM 정보:"
    echo "  - 이름: $vm_name"
    echo "  - OS: $os_type ($(get_os_description "$os_type"))"
    echo "  - 스펙: $spec ($(get_spec_details "$spec"))"
    echo "  - 대수: $count"
    echo ""

    if ! prompt_confirm "VM을 생성하시겠습니까?" "y"; then
        log_info "취소되었습니다"
        exit 0
    fi

    echo ""

    # VM 생성
    local created=0
    local failed=0

    for ((i=1; i<=count; i++)); do
        local current_vm_name
        if [[ $count -eq 1 ]]; then
            current_vm_name="$vm_name"
        else
            current_vm_name="${vm_name}-${i}"
        fi

        if create_single_vm "$current_vm_name" "$os_type" "$spec" "$CURRENT_USER"; then
            ((created++)) || true
        else
            ((failed++)) || true
        fi
    done

    echo ""
    echo "=========================================="
    echo "생성 완료: $created / $count"
    if [[ $failed -gt 0 ]]; then
        echo "실패: $failed"
    fi
    echo "=========================================="
    echo ""
    echo "VM 접속: ssh $default_user@<IP_ADDRESS>"
    echo "VM 목록: list-vms"
}

main "$@"
