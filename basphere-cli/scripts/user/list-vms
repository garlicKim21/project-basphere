#!/bin/bash
#
# VM 목록 조회 스크립트 (사용자용)
#
# 사용법: list-vms
#

set -euo pipefail

# 공통 라이브러리 로드
source /usr/local/lib/basphere/common.sh 2>/dev/null || {
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    source "$SCRIPT_DIR/../../lib/common.sh"
}

# 현재 사용자
CURRENT_USER=$(get_current_user)

# 사용법
usage() {
    cat << EOF
VM 목록 조회

사용법: list-vms [옵션]

옵션:
  -a, --all       상세 정보 포함
  -j, --json      JSON 형식 출력
  -h, --help      도움말
EOF
    exit 0
}

# 메인 함수
main() {
    local show_all=false
    local json_output=false

    # 인자 파싱
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -a|--all)
                show_all=true
                shift
                ;;
            -j|--json)
                json_output=true
                shift
                ;;
            -h|--help)
                usage
                ;;
            *)
                log_error "알 수 없는 옵션: $1"
                usage
                ;;
        esac
    done

    # 사용자 확인
    if ! user_exists "$CURRENT_USER"; then
        log_error "Basphere 사용자가 아닙니다: $CURRENT_USER"
        exit 1
    fi

    local tf_dir="$BASPHERE_DATA_DIR/terraform/$CURRENT_USER"

    # VM 디렉토리가 없거나 비어있는 경우
    if [[ ! -d "$tf_dir" ]] || [[ -z "$(ls -A "$tf_dir" 2>/dev/null)" ]]; then
        if [[ "$json_output" == "true" ]]; then
            echo "[]"
        else
            echo "생성된 VM이 없습니다."
            echo ""
            echo "VM 생성: create-vm"
        fi
        exit 0
    fi

    # JSON 출력
    if [[ "$json_output" == "true" ]]; then
        local vms_json="["
        local first=true

        for vm_dir in "$tf_dir"/*/; do
            [[ ! -d "$vm_dir" ]] && continue

            local metadata_file="$vm_dir/metadata.json"
            if [[ -f "$metadata_file" ]]; then
                if [[ "$first" == "true" ]]; then
                    first=false
                else
                    vms_json+=","
                fi
                vms_json+=$(cat "$metadata_file")
            fi
        done

        vms_json+="]"
        echo "$vms_json" | jq '.'
        exit 0
    fi

    # 테이블 출력
    echo ""
    echo "=== VM 목록 ($CURRENT_USER) ==="
    echo ""

    if [[ "$show_all" == "true" ]]; then
        print_table_header "%-20s %-16s %-10s %-10s %-20s" "NAME" "IP" "SPEC" "STATUS" "CREATED"
    else
        print_table_header "%-20s %-16s %-10s %-10s" "NAME" "IP" "SPEC" "STATUS"
    fi

    local count=0

    for vm_dir in "$tf_dir"/*/; do
        [[ ! -d "$vm_dir" ]] && continue

        local vm_name
        vm_name=$(basename "$vm_dir")

        local metadata_file="$vm_dir/metadata.json"

        if [[ -f "$metadata_file" ]]; then
            local ip_address spec status created_at

            ip_address=$(jq -r '.ip_address // "-"' "$metadata_file")
            spec=$(jq -r '.spec // "-"' "$metadata_file")
            status=$(jq -r '.status // "unknown"' "$metadata_file")
            created_at=$(jq -r '.created_at // "-"' "$metadata_file" | cut -d'T' -f1)

            # 상태에 따른 색상
            local status_display="$status"
            case "$status" in
                running)
                    status_display="${GREEN}running${NC}"
                    ;;
                creating)
                    status_display="${YELLOW}creating${NC}"
                    ;;
                failed)
                    status_display="${RED}failed${NC}"
                    ;;
            esac

            if [[ "$show_all" == "true" ]]; then
                printf "%-20s %-16s %-10s %-10b %-20s\n" "$vm_name" "$ip_address" "$spec" "$status_display" "$created_at"
            else
                printf "%-20s %-16s %-10s %-10b\n" "$vm_name" "$ip_address" "$spec" "$status_display"
            fi

            ((count++)) || true
        fi
    done

    echo ""
    echo "총 ${count}개 VM"

    # Quota 정보
    local max_vms
    max_vms=$(get_config '.quotas.default.max_vms' '10')
    echo "할당량: $count / $max_vms"
}

main "$@"
