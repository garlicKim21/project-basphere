#!/bin/bash
#
# VM 삭제 스크립트 (사용자용)
#
# 사용법: delete-vm <vm-name> [옵션]
#
# 일반 모드: API 서버를 통해 VM 삭제
# API 모드 (--api): 직접 Terraform 실행 (API 서버에서 호출)
#

set -euo pipefail

# 공통 라이브러리 로드
source /usr/local/lib/basphere/common.sh 2>/dev/null || {
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    source "$SCRIPT_DIR/../../lib/common.sh"
}

# 내부 스크립트 경로
INTERNAL_SCRIPTS="/usr/local/lib/basphere/internal"
if [[ ! -d "$INTERNAL_SCRIPTS" ]]; then
    INTERNAL_SCRIPTS="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/../internal"
fi

# 현재 사용자
CURRENT_USER=$(get_current_user)

# 사용법
usage() {
    cat << EOF
VM 삭제

사용법: delete-vm <vm-name> [옵션]

인자:
  vm-name       삭제할 VM 이름

옵션:
  -f, --force   확인 없이 삭제
  -h, --help    도움말

예시:
  delete-vm my-server
  delete-vm my-server -f
EOF
    exit 0
}

# VM 삭제 실행 (API 모드 - Terraform 직접 실행)
delete_single_vm_api_mode() {
    local vm_name="$1"
    local user="$2"

    local tf_dir="$BASPHERE_DATA_DIR/terraform/$user/$vm_name"
    local metadata_file="$tf_dir/metadata.json"

    # VM 존재 확인
    if [[ ! -d "$tf_dir" ]]; then
        echo "{\"error\": \"VM not found: $vm_name\"}" >&2
        return 1
    fi

    # 메타데이터에서 정보 가져오기
    local ip_address=""
    local os_type=""
    if [[ -f "$metadata_file" ]]; then
        ip_address=$(jq -r '.ip_address // ""' "$metadata_file")
        os_type=$(jq -r '.os // ""' "$metadata_file")
    fi

    # 상태 업데이트
    if [[ -f "$metadata_file" ]]; then
        jq '.status = "deleting"' "$metadata_file" > "$metadata_file.tmp" && \
            mv "$metadata_file.tmp" "$metadata_file"
    fi

    # Terraform destroy 실행
    local destroy_success=true

    if [[ -f "$tf_dir/main.tf" ]]; then
        (
            cd "$tf_dir"

            # 환경변수 로드
            if [[ -f "$BASPHERE_VSPHERE_ENV" ]]; then
                set -a
                source "$BASPHERE_VSPHERE_ENV"
                set +a
            fi

            # terraform destroy
            if ! terraform destroy -auto-approve -no-color > terraform-destroy.log 2>&1; then
                exit 1
            fi
        )

        if [[ $? -ne 0 ]]; then
            destroy_success=false
        fi
    fi

    # IP 반환
    if [[ -n "$ip_address" ]]; then
        "$INTERNAL_SCRIPTS/release-ip" "$ip_address" "$user" 2>/dev/null || true
    fi

    # Terraform 디렉토리 삭제
    rm -rf "$tf_dir"

    # 감사 로그
    audit_log "DELETE_VM" "$vm_name" "user=$user,os=$os_type,ip=$ip_address"

    # JSON 출력
    if [[ "$destroy_success" == "true" ]]; then
        echo "{\"success\": true, \"message\": \"VM deleted\", \"name\": \"$vm_name\"}"
    else
        echo "{\"success\": true, \"message\": \"VM deleted with warnings\", \"name\": \"$vm_name\"}"
    fi

    return 0
}

# 일반 모드 - API를 통한 VM 삭제
delete_vm_via_api() {
    local vm_name="$1"

    # API 연결 확인
    if ! check_api_connection; then
        exit 1
    fi

    log_info "VM 삭제 요청 중..."

    # API 호출
    local response
    response=$(api_call "DELETE" "/api/v1/vms/$vm_name")

    # 응답 파싱
    local success
    success=$(api_check_success "$response")

    if [[ "$success" == "true" ]]; then
        log_success "VM 삭제 완료: $vm_name"
        return 0
    else
        local error_msg
        error_msg=$(api_get_error "$response")
        log_error "VM 삭제 실패: $error_msg"
        return 1
    fi
}

# 메인 함수
main() {
    local vm_name=""
    local force=false
    local api_mode=false
    local target_user=""

    # 인자 파싱
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--force)
                force=true
                shift
                ;;
            --api)
                api_mode=true
                shift
                ;;
            --user)
                target_user="$2"
                shift 2
                ;;
            -h|--help)
                usage
                ;;
            -*)
                log_error "알 수 없는 옵션: $1"
                usage
                ;;
            *)
                if [[ -z "$vm_name" ]]; then
                    vm_name="$1"
                fi
                shift
                ;;
        esac
    done

    # VM 이름 필수
    if [[ -z "$vm_name" ]]; then
        log_error "VM 이름이 필요합니다"
        echo "사용법: delete-vm <vm-name>"
        exit 1
    fi

    # API 모드: Terraform 직접 실행 (API 서버에서 호출)
    if [[ "$api_mode" == "true" ]]; then
        local user="${target_user:-$CURRENT_USER}"

        if delete_single_vm_api_mode "$vm_name" "$user"; then
            exit 0
        else
            exit 1
        fi
    fi

    # 일반 모드: 사용자 확인 후 API 호출

    # 사용자 확인
    if ! user_exists "$CURRENT_USER"; then
        log_error "Basphere 사용자가 아닙니다: $CURRENT_USER"
        exit 1
    fi

    # VM 존재 확인 (로컬 체크)
    if ! vm_name_exists "$CURRENT_USER" "$vm_name"; then
        log_error "VM을 찾을 수 없습니다: $vm_name"
        exit 1
    fi

    # VM 정보 표시
    local tf_dir="$BASPHERE_DATA_DIR/terraform/$CURRENT_USER/$vm_name"
    local metadata_file="$tf_dir/metadata.json"

    if [[ -f "$metadata_file" ]]; then
        echo ""
        echo "삭제할 VM 정보:"
        echo "  - 이름: $vm_name"
        echo "  - IP: $(jq -r '.ip_address // "-"' "$metadata_file")"
        echo "  - OS: $(jq -r '.os // "-"' "$metadata_file")"
        echo "  - 스펙: $(jq -r '.spec // "-"' "$metadata_file")"
        echo "  - 상태: $(jq -r '.status // "-"' "$metadata_file")"
        echo ""
    fi

    # 확인
    if [[ "$force" != "true" ]]; then
        if ! prompt_confirm "정말로 VM '$vm_name'을(를) 삭제하시겠습니까?"; then
            log_info "취소되었습니다"
            exit 0
        fi
    fi

    echo ""

    # API를 통해 VM 삭제
    if delete_vm_via_api "$vm_name"; then
        exit 0
    else
        exit 1
    fi
}

main "$@"
