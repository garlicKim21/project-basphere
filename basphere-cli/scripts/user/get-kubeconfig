#!/bin/bash
#
# 클러스터 kubeconfig 조회 스크립트 (사용자용)
# Stage 2: Cluster API 기반 프로비저닝
#
# 사용법: get-kubeconfig <cluster-name>
#

set -euo pipefail

# 공통 라이브러리 로드
source /usr/local/lib/basphere/common.sh 2>/dev/null || {
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    source "$SCRIPT_DIR/../../lib/common.sh"
}

# 클러스터 공통 라이브러리 로드
source /usr/local/lib/basphere/cluster-common.sh 2>/dev/null || {
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    source "$SCRIPT_DIR/../../lib/cluster-common.sh"
}

# 현재 사용자
CURRENT_USER=$(get_current_user)

# 사용법
usage() {
    cat << EOF
클러스터 kubeconfig 조회

사용법: get-kubeconfig <cluster-name> [옵션]

옵션:
  -o, --output <file>   파일로 저장 (기본: stdout)
  --refresh             Management 클러스터에서 새로 추출
  -h, --help            도움말

예시:
  get-kubeconfig my-cluster                      # stdout 출력
  get-kubeconfig my-cluster -o ~/.kube/my-cluster.yaml  # 파일 저장
  get-kubeconfig my-cluster --refresh            # 새로 추출
EOF
    exit 0
}

# kubeconfig 조회 (API 경유)
get_kubeconfig_via_api() {
    local cluster_name="$1"
    local output_file="$2"
    local refresh="$3"

    # API 연결 확인
    if ! check_api_connection; then
        exit 1
    fi

    # API 호출
    local endpoint="/api/v1/clusters/$cluster_name/kubeconfig"
    if [[ "$refresh" == "true" ]]; then
        endpoint="${endpoint}?refresh=true"
    fi

    local response
    response=$(api_call "GET" "$endpoint")

    # 응답 확인
    local success
    success=$(echo "$response" | jq -r '.success // false' 2>/dev/null || echo "false")

    if [[ "$success" == "true" ]]; then
        local kubeconfig
        kubeconfig=$(echo "$response" | jq -r '.data.kubeconfig // empty')

        if [[ -z "$kubeconfig" ]]; then
            log_error "kubeconfig를 가져올 수 없습니다"
            log_info "클러스터가 아직 준비되지 않았을 수 있습니다"
            log_info "상태 확인: watch-cluster $cluster_name"
            return 1
        fi

        if [[ -n "$output_file" ]]; then
            echo "$kubeconfig" > "$output_file"
            chmod 600 "$output_file"
            log_success "kubeconfig 저장됨: $output_file"
            echo ""
            echo "사용법:"
            echo "  export KUBECONFIG=$output_file"
            echo "  kubectl get nodes"
        else
            echo "$kubeconfig"
        fi

        return 0
    else
        local error_msg
        error_msg=$(api_get_error "$response")
        log_error "kubeconfig 조회 실패: $error_msg"
        return 1
    fi
}

# 로컬에서 직접 조회
get_kubeconfig_local() {
    local cluster_name="$1"
    local output_file="$2"
    local refresh="$3"

    # 클러스터 존재 확인
    if ! cluster_exists "$CURRENT_USER" "$cluster_name"; then
        log_error "클러스터를 찾을 수 없습니다: $cluster_name"
        exit 1
    fi

    local kubeconfig_path
    kubeconfig_path=$(get_cluster_kubeconfig_path "$CURRENT_USER" "$cluster_name")

    # 새로 추출 요청
    if [[ "$refresh" == "true" ]] || [[ ! -f "$kubeconfig_path" ]]; then
        log_info "kubeconfig 추출 중..."

        if ! check_management_cluster; then
            log_error "Management 클러스터에 연결할 수 없습니다"
            exit 1
        fi

        if ! extract_cluster_kubeconfig "$CURRENT_USER" "$cluster_name"; then
            log_error "kubeconfig 추출 실패"
            log_info "클러스터가 아직 준비되지 않았을 수 있습니다"
            exit 1
        fi
    fi

    if [[ ! -f "$kubeconfig_path" ]]; then
        log_error "kubeconfig 파일을 찾을 수 없습니다"
        log_info "클러스터가 아직 프로비저닝 중일 수 있습니다"
        log_info "상태 확인: watch-cluster $cluster_name"
        exit 1
    fi

    if [[ -n "$output_file" ]]; then
        cp "$kubeconfig_path" "$output_file"
        chmod 600 "$output_file"
        log_success "kubeconfig 저장됨: $output_file"
        echo ""
        echo "사용법:"
        echo "  export KUBECONFIG=$output_file"
        echo "  kubectl get nodes"
    else
        cat "$kubeconfig_path"
    fi
}

# 메인 함수
main() {
    local cluster_name=""
    local output_file=""
    local refresh=false

    # 인자 파싱
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -o|--output)
                output_file="$2"
                shift 2
                ;;
            --refresh)
                refresh=true
                shift
                ;;
            -h|--help)
                usage
                ;;
            -*)
                log_error "알 수 없는 옵션: $1"
                usage
                ;;
            *)
                if [[ -z "$cluster_name" ]]; then
                    cluster_name="$1"
                else
                    log_error "인자가 너무 많습니다"
                    usage
                fi
                shift
                ;;
        esac
    done

    if [[ -z "$cluster_name" ]]; then
        log_error "클러스터 이름을 지정하세요"
        usage
    fi

    # 사용자 확인
    if ! user_exists "$CURRENT_USER"; then
        log_error "Basphere 사용자가 아닙니다: $CURRENT_USER"
        exit 1
    fi

    # API 연결 가능하면 API 경유, 아니면 로컬 조회
    if check_api_connection 2>/dev/null; then
        get_kubeconfig_via_api "$cluster_name" "$output_file" "$refresh"
    else
        get_kubeconfig_local "$cluster_name" "$output_file" "$refresh"
    fi
}

main "$@"
