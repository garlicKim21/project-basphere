#!/bin/bash
#
# IP 블록 할당 스크립트
# 사용자에게 32개 IP 블록을 할당합니다.
#
# 사용법: allocate-block <username>
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/ipam-common.sh"

# 사용법 출력
usage() {
    echo "사용법: allocate-block <username>"
    echo ""
    echo "사용자에게 IP 블록을 할당합니다."
    exit 1
}

# 메인 함수
main() {
    local user="${1:-}"

    if [[ -z "$user" ]]; then
        usage
    fi

    # 네트워크 설정 로드
    load_network_config

    # 락 획득
    if ! acquire_lock "$IPAM_LOCK"; then
        log_error "IPAM 락 획득 실패"
        exit 1
    fi
    trap 'release_lock' EXIT

    # 이미 블록이 할당되어 있는지 확인
    if get_user_block "$user" > /dev/null 2>&1; then
        local existing_block
        existing_block=$(get_user_block "$user")
        log_warn "사용자 '$user'에게 이미 블록이 할당되어 있습니다: $existing_block"
        echo "$existing_block"
        exit 0
    fi

    # 다음 사용 가능한 블록 찾기
    local block_start
    if ! block_start=$(find_next_available_block); then
        log_error "사용 가능한 IP 블록이 없습니다"
        exit 1
    fi

    # 블록 할당 기록
    local timestamp
    timestamp=$(get_timestamp)

    echo -e "${user}\t${block_start}\t${timestamp}" >> "$ALLOCATIONS_FILE"

    # 감사 로그
    audit_log "ALLOCATE_BLOCK" "$user" "block_start=$block_start,block_size=$NETWORK_BLOCK_SIZE"

    log_success "IP 블록 할당 완료: $user -> $block_start (${NETWORK_BLOCK_SIZE}개 IP)"
    echo "$block_start"
}

main "$@"
