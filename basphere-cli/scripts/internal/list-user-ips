#!/bin/bash
#
# 사용자 IP 목록 조회 스크립트
#
# 사용법: list-user-ips <username>
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/ipam-common.sh"

# 사용법 출력
usage() {
    echo "사용법: list-user-ips <username>"
    echo ""
    echo "사용자의 IP 할당 현황을 조회합니다."
    exit 1
}

# 메인 함수
main() {
    local user="${1:-}"

    if [[ -z "$user" ]]; then
        usage
    fi

    # 네트워크 설정 로드
    load_network_config

    # 사용자 블록 정보
    local block_start block_range
    if block_start=$(get_user_block "$user"); then
        block_range=$(format_ip_block_range "$block_start" "$NETWORK_BLOCK_SIZE")
        echo "=== 블록 정보 ==="
        echo "블록 범위: $block_range"
        echo "블록 크기: $NETWORK_BLOCK_SIZE"
        echo ""
    else
        echo "할당된 블록이 없습니다."
        exit 0
    fi

    # IP 사용 현황
    echo "=== IP 할당 현황 ==="

    if [[ ! -f "$LEASES_FILE" ]]; then
        echo "할당된 IP가 없습니다."
        exit 0
    fi

    local count=0
    print_table_header "%-18s %-25s %-10s %s" "IP" "리소스" "타입" "할당일시"

    while IFS=$'\t' read -r ip lease_user resource_name resource_type timestamp; do
        [[ "$ip" =~ ^#.*$ || -z "$ip" ]] && continue

        if [[ "$lease_user" == "$user" ]]; then
            print_table_row "%-18s %-25s %-10s %s" "$ip" "$resource_name" "$resource_type" "$timestamp"
            ((count++)) || true
        fi
    done < "$LEASES_FILE"

    echo ""
    echo "총 $count개 IP 사용 중 (최대: $(get_config '.quotas.default.max_ips' "$NETWORK_BLOCK_SIZE"))"
}

main "$@"
