# Basphere Cluster API Manifest Template
# Generated by basphere-cli for user: ${OWNER}
# Cluster: ${CLUSTER_NAME}
#
# 이 파일은 Cluster API (CAPI)와 CAPV를 사용하여
# vSphere에 Kubernetes 클러스터를 프로비저닝합니다.
#
---
# Cluster 리소스 - 클러스터의 최상위 정의
apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  name: ${CLUSTER_NAME}
  namespace: ${NAMESPACE}
  labels:
    basphere.dev/owner: ${OWNER}
    basphere.dev/cluster-type: ${CLUSTER_TYPE}
spec:
  clusterNetwork:
    pods:
      cidrBlocks:
        - 192.168.0.0/16  # Calico 기본 Pod CIDR
    services:
      cidrBlocks:
        - 10.128.0.0/12
  controlPlaneRef:
    apiVersion: controlplane.cluster.x-k8s.io/v1beta1
    kind: KubeadmControlPlane
    name: ${CLUSTER_NAME}-control-plane
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
    kind: VSphereCluster
    name: ${CLUSTER_NAME}

---
# VSphereCluster - vSphere 인프라 설정
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: VSphereCluster
metadata:
  name: ${CLUSTER_NAME}
  namespace: ${NAMESPACE}
spec:
  controlPlaneEndpoint:
    host: ${CONTROL_PLANE_IP}
    port: 6443
  identityRef:
    kind: Secret
    name: ${CLUSTER_NAME}-vsphere-credentials
  server: ${VSPHERE_SERVER}
  thumbprint: "${VSPHERE_TLS_THUMBPRINT}"

---
# vSphere 인증 Secret
apiVersion: v1
kind: Secret
metadata:
  name: ${CLUSTER_NAME}-vsphere-credentials
  namespace: ${NAMESPACE}
type: Opaque
stringData:
  username: "${VSPHERE_USERNAME}"
  password: "${VSPHERE_PASSWORD}"

---
# KubeadmControlPlane - Control Plane 노드 정의
apiVersion: controlplane.cluster.x-k8s.io/v1beta1
kind: KubeadmControlPlane
metadata:
  name: ${CLUSTER_NAME}-control-plane
  namespace: ${NAMESPACE}
spec:
  kubeadmConfigSpec:
    clusterConfiguration:
      apiServer:
        extraArgs:
          cloud-provider: external
      controllerManager:
        extraArgs:
          cloud-provider: external
    files:
      # CNI 설정 (Calico)
      - content: |
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: cni-config
        owner: root:root
        path: /etc/kubernetes/manifests/cni-config.yaml
        permissions: "0644"
    initConfiguration:
      nodeRegistration:
        criSocket: /var/run/containerd/containerd.sock
        kubeletExtraArgs:
          cloud-provider: external
        name: '{{ local_hostname }}'
    joinConfiguration:
      nodeRegistration:
        criSocket: /var/run/containerd/containerd.sock
        kubeletExtraArgs:
          cloud-provider: external
        name: '{{ local_hostname }}'
    preKubeadmCommands:
      - hostnamectl set-hostname "{{ local_hostname }}"
      - echo "::1         ipv6-localhost ipv6-loopback localhost6 localhost6.localdomain6" >/etc/hosts
      - echo "127.0.0.1   {{ local_hostname }} localhost localhost.localdomain localhost4 localhost4.localdomain4" >>/etc/hosts
    postKubeadmCommands:
      # Calico CNI 설치
      - kubectl --kubeconfig=/etc/kubernetes/admin.conf apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/calico.yaml
    users:
      - name: basphere
        sshAuthorizedKeys:
          - "${SSH_AUTHORIZED_KEY}"
        sudo: ALL=(ALL) NOPASSWD:ALL
  machineTemplate:
    infrastructureRef:
      apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
      kind: VSphereMachineTemplate
      name: ${CLUSTER_NAME}-control-plane
  replicas: ${CONTROL_PLANE_COUNT}
  version: ${KUBERNETES_VERSION}

---
# Control Plane VSphereMachineTemplate
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: VSphereMachineTemplate
metadata:
  name: ${CLUSTER_NAME}-control-plane
  namespace: ${NAMESPACE}
spec:
  template:
    spec:
      cloneMode: linkedClone
      datacenter: ${VSPHERE_DATACENTER}
      datastore: ${VSPHERE_DATASTORE}
      diskGiB: ${CONTROL_PLANE_DISK}
      folder: ${VSPHERE_FOLDER}
      memoryMiB: ${CONTROL_PLANE_MEMORY}
      network:
        devices:
          - dhcp4: false
            networkName: ${VSPHERE_NETWORK}
            addressesFromPools:
              - apiGroup: ipam.cluster.x-k8s.io
                kind: InClusterIPPool
                name: ${CLUSTER_NAME}-ip-pool
      numCPUs: ${CONTROL_PLANE_CPU}
      resourcePool: ${VSPHERE_RESOURCE_POOL}
      server: ${VSPHERE_SERVER}
      storagePolicyName: ""
      template: ${KUBERNETES_TEMPLATE}
      thumbprint: "${VSPHERE_TLS_THUMBPRINT}"

---
# MachineDeployment - Worker 노드 정의
apiVersion: cluster.x-k8s.io/v1beta1
kind: MachineDeployment
metadata:
  name: ${CLUSTER_NAME}-workers
  namespace: ${NAMESPACE}
  labels:
    basphere.dev/owner: ${OWNER}
spec:
  clusterName: ${CLUSTER_NAME}
  replicas: ${WORKER_COUNT}
  selector:
    matchLabels: null
  template:
    spec:
      bootstrap:
        configRef:
          apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
          kind: KubeadmConfigTemplate
          name: ${CLUSTER_NAME}-workers
      clusterName: ${CLUSTER_NAME}
      infrastructureRef:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: VSphereMachineTemplate
        name: ${CLUSTER_NAME}-workers
      version: ${KUBERNETES_VERSION}

---
# Worker VSphereMachineTemplate
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: VSphereMachineTemplate
metadata:
  name: ${CLUSTER_NAME}-workers
  namespace: ${NAMESPACE}
spec:
  template:
    spec:
      cloneMode: linkedClone
      datacenter: ${VSPHERE_DATACENTER}
      datastore: ${VSPHERE_DATASTORE}
      diskGiB: ${WORKER_DISK}
      folder: ${VSPHERE_FOLDER}
      memoryMiB: ${WORKER_MEMORY}
      network:
        devices:
          - dhcp4: false
            networkName: ${VSPHERE_NETWORK}
            addressesFromPools:
              - apiGroup: ipam.cluster.x-k8s.io
                kind: InClusterIPPool
                name: ${CLUSTER_NAME}-ip-pool
      numCPUs: ${WORKER_CPU}
      resourcePool: ${VSPHERE_RESOURCE_POOL}
      server: ${VSPHERE_SERVER}
      storagePolicyName: ""
      template: ${KUBERNETES_TEMPLATE}
      thumbprint: "${VSPHERE_TLS_THUMBPRINT}"

---
# Worker KubeadmConfigTemplate
apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
kind: KubeadmConfigTemplate
metadata:
  name: ${CLUSTER_NAME}-workers
  namespace: ${NAMESPACE}
spec:
  template:
    spec:
      joinConfiguration:
        nodeRegistration:
          criSocket: /var/run/containerd/containerd.sock
          kubeletExtraArgs:
            cloud-provider: external
          name: '{{ local_hostname }}'
      preKubeadmCommands:
        - hostnamectl set-hostname "{{ local_hostname }}"
        - echo "::1         ipv6-localhost ipv6-loopback localhost6 localhost6.localdomain6" >/etc/hosts
        - echo "127.0.0.1   {{ local_hostname }} localhost localhost.localdomain localhost4 localhost4.localdomain4" >>/etc/hosts
      users:
        - name: basphere
          sshAuthorizedKeys:
            - "${SSH_AUTHORIZED_KEY}"
          sudo: ALL=(ALL) NOPASSWD:ALL

---
# InClusterIPPool - 정적 IP 할당을 위한 IP Pool (IPAM Provider 필요)
# 주의: 이 리소스는 IPAM Provider (예: in-cluster)가 설치되어 있어야 작동합니다
# 설치: clusterctl init --ipam in-cluster
apiVersion: ipam.cluster.x-k8s.io/v1beta1
kind: InClusterIPPool
metadata:
  name: ${CLUSTER_NAME}-ip-pool
  namespace: ${NAMESPACE}
spec:
  addresses:
    - ${CONTROL_PLANE_IP}
${WORKER_IP_ADDRESSES}
  prefix: ${NETWORK_PREFIX}
  gateway: ${NETWORK_GATEWAY}

---
# VSphereClusterIdentity - 클러스터 레벨 vSphere 인증
# (선택사항: 개별 클러스터 Secret 대신 사용 가능)
# apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
# kind: VSphereClusterIdentity
# metadata:
#   name: ${CLUSTER_NAME}-identity
#   namespace: ${NAMESPACE}
# spec:
#   secretName: ${CLUSTER_NAME}-vsphere-credentials
#   allowedNamespaces:
#     selector:
#       matchLabels:
#         basphere.dev/owner: ${OWNER}
