# Basphere nginx configuration
#
# 설치 방법:
#   1. nginx.conf에 rate limiting zone 추가 (http 블록 안에):
#      limit_req_zone $binary_remote_addr zone=basphere_general:10m rate=10r/s;
#      limit_req_zone $binary_remote_addr zone=basphere_register:10m rate=1r/s;
#
#   2. 설정 파일 복사 및 활성화:
#      sudo cp basphere.conf /etc/nginx/sites-available/basphere
#      sudo ln -s /etc/nginx/sites-available/basphere /etc/nginx/sites-enabled/
#      sudo nginx -t && sudo systemctl reload nginx

upstream basphere_api {
    server 127.0.0.1:8080;
    keepalive 32;
}

server {
    listen 80;
    server_name _;  # 모든 호스트명 허용 (필요시 실제 도메인으로 변경)

    # 로그
    access_log /var/log/nginx/basphere_access.log;
    error_log /var/log/nginx/basphere_error.log;

    # 보안 헤더
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # ===========================================
    # 공개 엔드포인트 (외부 접근 허용)
    # ===========================================

    # 웹 UI - 메인 페이지
    location / {
        limit_req zone=basphere_general burst=20 nodelay;

        proxy_pass http://basphere_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    # 등록 페이지 (GET) - 일반 rate limiting
    location = /register {
        limit_req zone=basphere_general burst=10 nodelay;

        proxy_pass http://basphere_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    location /success {
        proxy_pass http://basphere_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    location /ssh-guide {
        proxy_pass http://basphere_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    # 키 변경 페이지 (GET) - 일반 rate limiting
    location = /key-change {
        limit_req zone=basphere_general burst=10 nodelay;

        proxy_pass http://basphere_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    location /key-change-success {
        proxy_pass http://basphere_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    # 헬스체크
    location /health {
        proxy_pass http://basphere_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    # 등록 API (POST만 허용) - 엄격한 rate limiting
    # 1r/s = IP당 1초에 1개 요청, burst=5 = 최대 5개 대기열
    location = /api/v1/register {
        limit_req zone=basphere_register burst=5 nodelay;
        limit_req_status 429;

        # POST 메소드만 허용
        limit_except POST {
            deny all;
        }

        proxy_pass http://basphere_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    # 키 변경 API (POST만 허용) - 엄격한 rate limiting
    location = /api/v1/key-change {
        limit_req zone=basphere_register burst=5 nodelay;
        limit_req_status 429;

        # POST 메소드만 허용
        limit_except POST {
            deny all;
        }

        proxy_pass http://basphere_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    # ===========================================
    # 내부 전용 API (외부 접근 차단)
    # ===========================================

    # VM 관리 API - 차단
    location /api/v1/vms {
        return 403 '{"success":false,"message":"Access denied"}';
        add_header Content-Type application/json;
    }

    # Quota API - 차단
    location /api/v1/quota {
        return 403 '{"success":false,"message":"Access denied"}';
        add_header Content-Type application/json;
    }

    # Pending/Admin API - 차단
    location /api/v1/pending {
        return 403 '{"success":false,"message":"Access denied"}';
        add_header Content-Type application/json;
    }

    location /api/v1/users {
        return 403 '{"success":false,"message":"Access denied"}';
        add_header Content-Type application/json;
    }

    # 키 변경 관리 API - 차단 (목록, 승인, 거부)
    location /api/v1/key-changes {
        return 403 '{"success":false,"message":"Access denied"}';
        add_header Content-Type application/json;
    }

    # 기타 모든 /api/ 요청 - 차단 (안전장치)
    location /api/ {
        return 403 '{"success":false,"message":"Access denied"}';
        add_header Content-Type application/json;
    }
}

# ===========================================
# HTTPS 설정 (Let's Encrypt 사용 시)
# ===========================================
#
# 1. certbot 설치:
#    sudo apt install certbot python3-certbot-nginx
#
# 2. 인증서 발급:
#    sudo certbot --nginx -d your-domain.com
#
# 3. 자동 갱신 확인:
#    sudo certbot renew --dry-run
