# Basphere nginx configuration
#
# 설치 방법:
#   sudo cp basphere.conf /etc/nginx/sites-available/basphere
#   sudo ln -s /etc/nginx/sites-available/basphere /etc/nginx/sites-enabled/
#   sudo nginx -t && sudo systemctl reload nginx

upstream basphere_api {
    server 127.0.0.1:8080;
    keepalive 32;
}

server {
    listen 80;
    server_name _;  # 모든 호스트명 허용 (필요시 실제 도메인으로 변경)

    # 로그
    access_log /var/log/nginx/basphere_access.log;
    error_log /var/log/nginx/basphere_error.log;

    # 보안 헤더
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Rate limiting zone (nginx.conf의 http 블록에 추가 필요)
    # limit_req_zone $binary_remote_addr zone=basphere_limit:10m rate=10r/s;

    # ===========================================
    # 공개 엔드포인트 (외부 접근 허용)
    # ===========================================

    # 웹 UI - 사용자 등록 관련 페이지
    location / {
        proxy_pass http://basphere_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # Rate limiting (선택사항)
        # limit_req zone=basphere_limit burst=20 nodelay;
    }

    location /register {
        proxy_pass http://basphere_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    location /success {
        proxy_pass http://basphere_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    location /ssh-guide {
        proxy_pass http://basphere_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    # 헬스체크
    location /health {
        proxy_pass http://basphere_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    # 등록 API (POST만 허용)
    location = /api/v1/register {
        # POST 메소드만 허용
        limit_except POST {
            deny all;
        }

        proxy_pass http://basphere_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";
    }

    # ===========================================
    # 내부 전용 API (외부 접근 차단)
    # ===========================================

    # VM 관리 API - 차단
    location /api/v1/vms {
        return 403 '{"success":false,"message":"Access denied"}';
        add_header Content-Type application/json;
    }

    # Quota API - 차단
    location /api/v1/quota {
        return 403 '{"success":false,"message":"Access denied"}';
        add_header Content-Type application/json;
    }

    # Pending/Admin API - 차단
    location /api/v1/pending {
        return 403 '{"success":false,"message":"Access denied"}';
        add_header Content-Type application/json;
    }

    location /api/v1/users {
        return 403 '{"success":false,"message":"Access denied"}';
        add_header Content-Type application/json;
    }

    # 기타 모든 /api/ 요청 - 차단 (안전장치)
    location /api/ {
        return 403 '{"success":false,"message":"Access denied"}';
        add_header Content-Type application/json;
    }
}

# ===========================================
# HTTPS 설정 (Let's Encrypt 사용 시)
# ===========================================
#
# 1. certbot 설치:
#    sudo apt install certbot python3-certbot-nginx
#
# 2. 인증서 발급:
#    sudo certbot --nginx -d your-domain.com
#
# 3. 자동 갱신 확인:
#    sudo certbot renew --dry-run
